import fs from 'fs';
import path, { dirname } from 'path';
import { fileURLToPath } from 'url';
import childProcess from 'child_process';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const env = process.argv[2];

if (env) {
  const packageUrl = {
    develop: 'https://develop.js.onrally.dev/package/',
    stage: 'https://stage.js.onrally.dev/package/',
    sandbox: 'https://js.sandbox.onrally.com/package/'
  };

  const packageJson = JSON.parse(fs.readFileSync(path.join(__dirname, `package.json`)));

  packageJson.dependencies['@rallycommerce/checkout-button'] = `${packageUrl[env]}rallycommerce-checkout-button.tgz`;

  fs.writeFileSync(path.join(__dirname, `package.json`), JSON.stringify(packageJson, null, 2));

  const newNpmInstall = childProcess.spawn('npm', ['install'], { stdio: 'inherit', cwd: __dirname });
  newNpmInstall.on('close', process.exit);
  newNpmInstall.on('error', process.exit);

}
